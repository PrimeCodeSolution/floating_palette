name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump
        type: choice
        required: true
        options:
          - patch
          - minor
          - major
      dry_run:
        description: Dry run (no commits or PRs)
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump versions
        id: bump
        run: |
          packages=(
            floating_palette_annotations
            floating_palette_generator
            floating_palette
          )

          # Read current version from annotations (all packages share the same version)
          current=$(grep '^version:' floating_palette_annotations/pubspec.yaml | awk '{print $2}')
          IFS='.' read -r major minor patch <<< "$current"

          case "${{ inputs.bump }}" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac
          new_version="$major.$minor.$patch"

          echo "Version: $current -> $new_version"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            for pkg in "${packages[@]}"; do
              echo "  $pkg: would bump to $new_version"
            done
            echo "dry_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Bump version in all pubspecs
          for pkg in "${packages[@]}"; do
            pubspec="$pkg/pubspec.yaml"
            sed -i "s/^version: .*/version: $new_version/" "$pubspec"
            echo "  $pkg/pubspec.yaml -> $new_version"
          done

          # Update cross-references (floating_palette and floating_palette_generator depend on annotations)
          for pkg in floating_palette floating_palette_generator; do
            pubspec="$pkg/pubspec.yaml"
            sed -i "s/floating_palette_annotations: \^.*/floating_palette_annotations: ^$new_version/" "$pubspec"
            echo "  $pkg/pubspec.yaml: updated annotations dependency to ^$new_version"
          done

          # Update changelogs
          date=$(date +%Y-%m-%d)
          for pkg in "${packages[@]}"; do
            changelog="$pkg/CHANGELOG.md"
            if [ -f "$changelog" ]; then
              sed -i "s/^## Unreleased$/## Unreleased\n\n## $new_version — $date/" "$changelog"
            fi
          done

          # Single commit for all changes
          git add -A
          git commit -m "chore: release v$new_version"

          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "dry_run=false" >> "$GITHUB_OUTPUT"

      - name: Push branch and create PR
        if: steps.bump.outputs.dry_run == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.bump.outputs.version }}"
          branch="release/v${version}"

          git checkout -b "$branch"
          git push -u origin "$branch"

          gh pr create \
            --base main \
            --head "$branch" \
            --title "chore: release v${version}" \
            --body "Automated release PR — all packages bumped to **v${version}**.

          Merge this PR to trigger automatic tagging and publishing to pub.dev.

          **Bump type:** ${{ inputs.bump }}
          **Packages:** floating_palette_annotations, floating_palette_generator, floating_palette"
